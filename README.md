# Aftermath Rust SDK

Crates for interacting with Aftermath's services and the Sui network. It aims to be light-weight and a complement to Sui's [sdk](https://github.com/MystenLabs/sui).

## Crates

- [`af-move-type-derive`](crates/af-move-type-derive)
    [![package on crates.io](https://img.shields.io/crates/v/af-move-type-derive)](https://crates.io/crates/af-move-type-derive)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/af-move-type-derive)

- [`af-sui-types`](crates/af-sui-types)
    [![package on crates.io](https://img.shields.io/crates/v/af-sui-types)](https://crates.io/crates/af-sui-types)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/af-sui-types)

- [`af-move-type`](crates/af-move-type)
    [![package on crates.io](https://img.shields.io/crates/v/af-move-type)](https://crates.io/crates/af-move-type)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/af-move-type)

- [`af-sui-pkg-sdk`](crates/af-sui-pkg-sdk)
    [![package on crates.io](https://img.shields.io/crates/v/af-sui-pkg-sdk)](https://crates.io/crates/af-sui-pkg-sdk)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/af-sui-pkg-sdk)

- [`move-stdlib-sdk`](crates/move-stdlib-sdk)
    [![package on crates.io](https://img.shields.io/crates/v/move-stdlib-sdk)](https://crates.io/crates/move-stdlib-sdk)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/move-stdlib-sdk)

- [`sui-framework-sdk`](crates/sui-framework-sdk)
    [![package on crates.io](https://img.shields.io/crates/v/sui-framework-sdk)](https://crates.io/crates/sui-framework-sdk)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/sui-framework-sdk)

- [`af-faucet`](crates/af-faucet)
    [![package on crates.io](https://img.shields.io/crates/v/af-faucet)](https://crates.io/crates/af-faucet)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/af-faucet)

- [`af-utilities`](crates/af-utilities)
    [![package on crates.io](https://img.shields.io/crates/v/af-utilities)](https://crates.io/crates/af-utilities)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/af-utilities)

- [`sui-gql-schema`](crates/sui-gql-schema)
    [![package on crates.io](https://img.shields.io/crates/v/sui-gql-schema)](https://crates.io/crates/sui-gql-schema)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/sui-gql-schema)

- [`sui-gql-client`](crates/sui-gql-client)
    [![package on crates.io](https://img.shields.io/crates/v/sui-gql-client)](https://crates.io/crates/sui-gql-client)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/sui-gql-client)

- [`af-iperps`](crates/af-iperps)
    [![package on crates.io](https://img.shields.io/crates/v/af-iperps)](https://crates.io/crates/af-iperps)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/af-iperps)

- [`af-keys`](crates/af-keys)
    [![package on crates.io](https://img.shields.io/crates/v/af-keys)](https://crates.io/crates/af-keys)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/af-keys)

- [`af-oracle`](crates/af-oracle)
    [![package on crates.io](https://img.shields.io/crates/v/af-oracle)](https://crates.io/crates/af-oracle)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/af-oracle)

- [`af-ptbuilder`](crates/af-ptbuilder)
    [![package on crates.io](https://img.shields.io/crates/v/af-ptbuilder)](https://crates.io/crates/af-ptbuilder)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/af-ptbuilder)

- [`af-pyth-wrapper`](crates/af-pyth-wrapper)
    [![package on crates.io](https://img.shields.io/crates/v/af-pyth-wrapper)](https://crates.io/crates/af-pyth-wrapper)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/af-pyth-wrapper)

- [`pyth-hermes-client`](crates/pyth-hermes-client)
    [![package on crates.io](https://img.shields.io/crates/v/pyth-hermes-client)](https://crates.io/crates/pyth-hermes-client)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/pyth-hermes-client)

- [`sui-jsonrpc`](crates/sui-jsonrpc)
    [![package on crates.io](https://img.shields.io/crates/v/sui-jsonrpc)](https://crates.io/crates/sui-jsonrpc)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/sui-jsonrpc)

- [`wormhole-sui-sdk`](crates/wormhole-sui-sdk)
    [![package on crates.io](https://img.shields.io/crates/v/wormhole-sui-sdk)](https://crates.io/crates/wormhole-sui-sdk)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/wormhole-sui-sdk)

- [`pyth-sui-sdk`](crates/pyth-sui-sdk)
    [![package on crates.io](https://img.shields.io/crates/v/pyth-sui-sdk)](https://crates.io/crates/pyth-sui-sdk)
    [![Documentation (latest release)](https://img.shields.io/badge/docs-latest-brightgreen)](https://docs.rs/pyth-sui-sdk)


## Using this SDK to read from/write to the Sui chain

### Executing a transaction on Sui (writing to the chain)

The flow for creating and submitting a PTB usually goes like this:
```rust
use sui_crypto::Signer as _;
use sui_crypto::ed25519::Ed25519PrivateKey;
use sui_gql_client::reqwest::ReqwestClient;
use sui_jsonrpc::api::WriteApiClient as _;
use sui_jsonrpc::client::SuiClientBuilder;
use sui_jsonrpc::msgs::SuiTransactionBlockResponseOptions

let sender: Ed25519PrivateKey;
let sender_address = sender.public_key().to_address();

// 1. Instantiate RPC clients
let graphql = ReqwestClient::new_default("https://sui-mainnet.mystenlabs.com/graphql");
let jrpc = SuiClientBuilder::default().build("https://fullnode.mainnet.sui.io:443").await?;

// 2. Build the ProgrammableTransaction
let ptb = build_ptb(&graphql, &sender_address).await?;
let kind = af_sui_types::TransactionKind::ProgrammableTransaction(ptb);

// 3. Get the reference gas price if you don't know it already
let price = jrpc.http().get_reference_gas_price().await?.into_inner();
// 4. (Optionally) dry-run the PTB via the RPC to get an estimate of the gas budget necessary
let budget = jrpc.gas_budget(&kind, sender_address, price).await?;
// 5. Set a gas budget and query the RPC for gas coins with suffient total balance
let gas_data = jrpc.get_gas_data(&kind, sender_address, budget, price).await?;

// 6. Sign the transaction (we're using `sui_crypto` here)
let transaction = af_sui_types::TransactionData::v1(
    kind,
    sender_address,
    gas_data,
    af_sui_types::TransactionExpiration::None,
);
let signature: UserSignature = sender.sign(&transaction.signing_digest());

// 7. Serialize transaction and signatures, then send then to the RPC
let resp = jrpc
    .http()
    .execute_transaction_block(
        transaction.encode_base64(),
        vec![signature.to_base64()],
        Some(SuiTransactionBlockResponseOptions::new().with_effects()),
        None,
    )
    .await?;
resp.check_execution_status()?;
```

Over time, a lot of JSON-RPC methods used above will be available through GraphQL/gRPC, since the former will be deprecated.

#### Programmable Transaction Blocks (PTBs)

PTBs define what actually will be executed onchain. The recommended way to build programmable transactions is using the [`ptb!`] macro. 

```rust
use af_sui_types::ProgrammableTransaction;
use sui_gql_client::GraphQlClient;

/// In this example, we're interacting with a package `foo` which allows us to create an account
/// object holding coins of a specific type. We want to create an account for `SUI` coins and
/// transfer it back to the sender in one transaction.
async fn build_ptb(client: &impl GraphQlClient, sender: &Address) -> Result<ProgrammableTransaction>
{
    use af_ptbuilder::ptb;
    use sui_gql_client::object_args;

    // 1. Request information (`ObjectArg`) for the objects you're interacting with from the RPC
    object_args!({
        mut registry: "0x1e7f38ee60107485e03da942029146ceb283bba1f2db8b8ad305739f42b5ef36".parse()?,
        coin: "0x68c7d900be4bcb322342fd9bf53e06c537d92f5fa76ce5fb359703fa45beccdb".parse()?,
    } with { client });

    // For functions with type arguments, you need to explicitly pass them
    // For example, here we're constructing the one-time-witness type for SUI coins.
    let otw = "0x2::sui::SUI".parse()?;

    // 2. Build the programmable transaction containing the inputs (objects/values) and the sequence
    //    of Move calls operating on those inputs
    let ptb = ptb!(
        package foo: "<package-id>".parse()?;

        type T = otw;

        input obj registry;
        input obj coin;

        input pure sender;

        let account = foo::registry::create_account<T>(registry, coin);
        command! TransferObjects(vec![account], sender);
    );
    Ok(ptb)
}
```

Check out [`ptb!`]'s API documentation for the full syntax.

[`ptb!`]: https://docs.rs/af-ptbuilder/latest/af_ptbuilder/macro.ptb.html

### Reading from the chain

The [`sui-gql-client`] crate provides pre-made queries for getting data from the Sui chain. Together with [`af-move-type`] and [`af-sui-pkg-sdk`], you can get full snapshots of the state of a package's objects as parsed Rust types.

A lot of crates here build on top of [`af-sui-pkg-sdk`] to generate Rust types corresponding to Move ones of their respective packages. [`sui-gql-client`] has helpers for converting the raw GraphQL responses into those generated Rust types.

We recommend checking out:
- The `clearing_house::Vault` declaration in [`af-iperps`] (`lib.rs`) for a simple example of how a Move type is transformed into Rust
- The `graphql::ch_vault` module in `af-iperps` for an example of a GraphQL query using our client and transforming the unparsed response into an `af-move-type`
- The [`clearing-house-vault`](./crates/af-iperps/examples/clearing_house_vault.rs) example for how it all comes together to display the on-chain Move state

Of course, displaying is just a toy example of what you can do with the converted Move types. At Aftermath we use these types to perform complex calculations that are too expensive to do onchain.

[`af-iperps`]: ./crates/af-iperps
[`af-move-type`]: ./crates/af-move-type
[`af-sui-pkg-sdk`]: ./crates/af-sui-pkg-sdk
[`sui-gql-client`]: ./crates/sui-gql-client

## Api documentation

To build the documentation locally, use
```
RUSTDOCFLAGS="-D warnings -Zunstable-options --generate-link-to-definition" cargo +nightly doc \
  -Zunstable-options \
  -Zrustdoc-map \
  --no-deps \
  --all-features
```
